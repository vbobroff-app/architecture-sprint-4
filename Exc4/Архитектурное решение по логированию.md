### Логирование
Логирование — это ведение журнала логов, который фиксирует, как состояние системы изменяется с течением времени.

Уровни логов: FATAL, ERROR, WARN, INFO, DEBUG, TRACE. 

В приложение необходимо собирать логи с сервисов АPi, с сервиса авторизации, с сервиса платежей.

Список логов с уровнем INFO:
* регистрация нового пользователя
* вход/выход пользователей
* статусы заказа
* статусы платежных операций
* внутренние статусы системы - информация о готовности, инициализации (перезагрузках) систем сервисов

### Мотивация
Логи — это один из источников информации для мониторинга. Поскольку в приложении возможны сбои, необходимо правильно установить причину сбоев, для устранения дальнейших неполадок в будущем. 

Логирование:
* помогает при отладке, а также позволяют собирать и анализировать данные о работе системы
* помогает обнаружить ошибки в работающем приложении 
* помогает сформировать представление о состоянии приложения 

Поскольку команда не сможет реализовать единовременно логирование и трейсинг всех выделенных для этого систем, настраивать логирование и трейсинг в первую очередь необходимо для  CRM (необходима своевременная информация о этапах выполнения заказов) и ESM API, здесь необходимо сосредоточить внимание на потоках данных, их обработку, своевременность, и возможных ошибках. 


### Предлагаемое решение
Предлагаемое решение включает стек OpenSearch, Logstash и Kibana. Решение имеет следующие преимущества:

* скорость поиска
* скорость индексации логов
* масштабируемость
* гибкость поисковых фильтров
* стабильность поискового движка


Внедрение логирования позволит отлеживать следующие важные метрики.

Технические метрики:
HTTP 200 - информация о вызовах API сервиса, запросах в БД, вызовах других сервисов  (INFO)
HTTP 500 - информация об ошибках (ERROR)
CPU % - загрузка процессора (WARN, FATAL)
Memory UTL - загрузка памяти (WARN, FATAL)
 
Бизнес-метрики:
DAU — логирование уникальных пользователей (INFO),
Password Error - неверный ввод пароля (WARN) 
Order per day - создание нового заказа (INFO),
Calc Error - ошибка расчета (ERROR),
Cancel order - отмена заказа (WARN).

У OpenSearch лицензия Apache 2.0, которая является разрешительной, конечный продукт с компонентами Apache 2.0 может иметь любую лицензию (в частности платную). У оригинального инструмента ElasticSearch — лицензия Elastic.

В Splunk цена за лицензию рассчитывается из количества гигабайтов данных, загруженных в день, независимо от количества узлов или пользователей.

[Реализация логирования](https://drive.google.com/file/d/1PDR1UQ2kaMmreMBzOS2g4pZM59_uRP03/view?usp=sharing)

Так как при анализе логов возможна работа с чувствительными данными, необходимо ограничить доступ к логам с уровнем администратора в сервисе APi Gateway.  

Для хранения необходимо реализовать отдельный индекс под систему, так как это ускорит поисковые запросы. Решением может быть индекс на день логирования. Время хранения необходимо ограничить (например 6 месяцев), поскольку ILM запускает ролловер, если истёк максимальный срок хранения данных. У каждого индекса может быть максимум 1024 сегмент, рекомендуемый размер сегментов 10–50 ГБ.

Kibana позволит настроить отчёт по бизнес-показателям заказов. Также необходимо настроить алеертинг на резкое увеличение заказов (свыше  100 в секунду), на выполнение расчетов в ESM (свыше 1000 в секунду), на регистрацию пользователей (свыше 100 новых пользователей за час).